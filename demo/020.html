<!DOCTYPE html>
<head>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="content">
    <canvas id="c"></canvas>
  </div>
  <script type="module">
import * as LMGL from '../src/LMGL.js'

class Triangle {
  constructor() {
    const vertexShader = `#version 300 es
      precision mediump float;
      in vec3 aPosition;
      in vec4 aColor;
      out vec4 vColor;

      uniform mat4 projectionMatrix;
      uniform mat4 modelViewMatrix;

      void main() {
      gl_Position = projectionMatrix * modelViewMatrix * vec4(aPosition, 1.0);
      vColor = aColor;
      }
    `

    const fragmentShader = `#version 300 es
      precision mediump float;
      in vec4 vColor;
      out vec4 FragColor;

      void main() {
        FragColor = vColor;
      }
      `
      const z = 0;
      const geo = {
        indices: [0, 1, 2],
        attribute: {
          aPosition: {
              value: [
              0, 1, z,
              -1., -0.5, z,
              1., -0.5, z
              ],
              itemSize: 3
            },
            aColor: {
              value: [
                1, 0., 0, 1,
                0., 1, 0., 1,
                0., 0., 1, 1,
              ],
              itemSize: 4
            }
        }
      };

      const matInfo = {
        vertexShader,
        fragmentShader,
      }

      const mat = new LMGL.Material(matInfo);
      this.mesh = new LMGL.Mesh(geo, mat);
  }
}

class Plane {
  constructor() {
    const vs = `#version 300 es
      precision mediump float;
      in vec3 aPosition;
      in vec2 aUv;
      out vec2 vUv;

      uniform mat4 projectionMatrix;
      uniform mat4 modelViewMatrix;

      void main() {
        gl_Position = projectionMatrix * modelViewMatrix * vec4(aPosition, 1.0);
        vUv = aUv;
      }
    `

    const fs = `#version 300 es
      precision mediump float;
      uniform sampler2D uTexture;
      in vec2 vUv;
      out vec4 FragColor;

      void main() {
        FragColor = texture(uTexture, vUv);
        FragColor = vec4(1.0);
      }
      `
    const model = LMGL.geometryLib.plane(1);
    const geoInfo = {
      indices: model.indices,
      attribute: {
        aPosition: {
          value: model.position,
          itemSize: 3
        },
        aUv: {
          value: model.uv,
          itemSize: 2,
        }
      }
    };

    const matInfo = {
      vertexShader: vs,
      fragmentShader: fs,
      uniforms:{
        uTexture: {type: "t", value: null},
      }
    }

    const mat = new LMGL.Material(matInfo);
    this.mesh = new LMGL.Mesh(geoInfo, mat);
  }
}

let stage

window.onload = () => {
  document.title = "多采样渲染缓冲"
  const width = window.innerWidth
  const height = window.innerHeight
  const ratio = window.devicePixelRatio;

  stage = new LMGL.Stage()
  stage.init(document.querySelector("#c"), width, height)
  stage.camera.position.set(0, 0, 5)

  // 自定义渲染
  // stage.setRenderState(false)
  const webgl = LMGL.webgl;
  const gl = stage.getGl()

  const textureSize = {
    w: width * ratio,
    h: height * ratio
  }
  // const msfb = new LMGL.MultisampleFrameBuffer(textureSize.w, textureSize.h,{
  //   textureCount: 2,
  //   depth: true,
  // });

  const triangle = new Triangle().mesh;
  const plane = new Plane().mesh;
  const camera = new LMGL.OrthographicCamera( - 1, 1, 1, - 1, 0, 1 );
  stage.add(plane);
  gl.clearColor(0.0, 0.0, 0.0, 1.0);
  gl.enable(gl.CULL_FACE);

  stage.addUpdate("loop",()=>{
    // stage.renderer.setRenderTarget(msfb);
    // stage.renderer.clear();
    // webgl.setViewPort(gl, textureSize.w, textureSize.h);
    // stage.renderer.renderMesh(triangle);

    // stage.renderer.setRenderTarget(null);
    // gl.activeTexture(gl.TEXTURE0);
    // gl.bindTexture(gl.TEXTURE_2D, msfb.getTexture());
    // stage.renderer.clear();
    // webgl.setViewPort(gl, width, height);
    // plane.material.uniforms["uTexture"].value = msfb.getTexture()
    // stage.renderer.renderMesh(triangle);
  })
  stage.run()
}

  </script>
</body>
</html>
