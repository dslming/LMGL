<!DOCTYPE html>
<head>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="content">
    <canvas id="c"></canvas>
  </div>
  <script type="module">
    // https://math.hws.edu/graphicsbook/c7/s4.html


    import * as lmgl from '../src/lmgl.js'
    window.lmgl = lmgl;

const vertexShader = `
  precision mediump float;
  attribute vec3 aPosition;
  attribute vec2 aUv;
  uniform mat4 projectionMatrix;
  uniform mat4 modelViewMatrix;
  varying vec2 vUv;
  void main() {
    vUv = aUv;
   gl_Position = projectionMatrix * modelViewMatrix * vec4(aPosition, 1.0);
  }
`

const fragmentShader = `
  precision mediump float;
  uniform sampler2D uTexture;
  varying vec2 vUv;
	void main() {
	  gl_FragColor = texture2D(uTexture, vec2(vUv.x, vUv.y));
    // gl_FragColor = vec4(1.,0.,0.,1.);
	}
	`
let stage

window.onload = () => {
  document.title = "模糊图片"
  const width = window.innerWidth
  const height = window.innerHeight

  stage = new lmgl.Stage()
  stage.init(document.querySelector("#c"), width, height)
  stage.camera.position.set(0, 0, 20)

  const center = {
    x: 0,
    y: 0
  }
  const size = 2
  const geo = {
    attribute: {
      aPosition: {
        value: [
          center.x - size, center.y + size, 0,
          center.x - size, center.y - size, 0,
          center.x + size, center.y - size, 0,
          center.x + size, center.y + size, 0,
        ],
        itemSize: 3
      },
      aUv:{
        // todo: y轴不对
        value: [ 0,0, 0,1,  1,1,1,0,],
        itemSize: 2
      }
    },
    indices: [0,1,2, 2,3,0]
  };

  lmgl.loadImage("./images/house.jpg", data => {
    const mat = {
      vertexShader,
      fragmentShader,
      uniforms: {
        uTexture: {
          value: data,
          type: "t"
        }
      }
    }
    let mesh = new lmgl.Mesh(geo, mat);
    stage.add(mesh);

    stage.setRenderState(false)
    stage.renderer.render();

    const webgl = lmgl.webgl;
    const gl = stage.getGl()

    stage.addOnUpdate("123",()=>{
      const program = mesh.material.program;
      const geometry = mesh.geometry;
      webgl.copyFramebufferToTexture(gl,"uTexture", program, 256,256)
      stage.renderer.renderOne(geometry);
    })



  })
  stage.run()
}

  </script>
</body>
</html>
